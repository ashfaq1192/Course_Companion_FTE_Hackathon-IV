# Data Model: Phase 2 - Hybrid Intelligence

**Feature**: Phase 2 - Hybrid Intelligence | **Date**: 2026-02-03
**Input**: Feature specification from `/specs/003-phase2-hybrid-intelligence/spec.md`

## Overview

Data model extensions for hybrid intelligence features in the Course Companion FTE project. This includes new entities for adaptive learning paths, LLM-graded assessments, cost tracking, and premium feature access control.

## Entity Relationships

```
[User] 1 ---- * [Subscription] 1 ---- * [HybridFeatureUsage]
                |
                * [CostMetric]
                
[User] 1 ---- * [AdaptiveLearningPath]
[User] 1 ---- * [LLMGradeAssessment]
[User] 1 ---- * [HybridFeatureUsage]

[CourseContent] 1 ---- * [AdaptiveLearningPath]
[QuizAttempt] 1 ---- * [LLMGradeAssessment]
```

## Detailed Entity Descriptions

### 1. AdaptiveLearningPath
- **Description**: Stores personalized learning paths generated by LLM analysis of user progress
- **Attributes**:
  - `id` (UUID, Primary Key): Unique identifier for the adaptive learning path
  - `user_id` (UUID, Foreign Key): Reference to the user who receives this path
  - `generated_at` (DateTime, Required): Timestamp when the path was generated
  - `recommended_courses` (JSON, Required): List of recommended course IDs with priorities
  - `reasoning` (Text, Optional): Explanation of why these recommendations were made
  - `valid_until` (DateTime, Optional): Expiration date for the recommendations
  - `is_active` (Boolean, Default: True): Whether the path is currently valid
  - `cost_usd` (Decimal, Optional): Cost incurred to generate this path

- **Constraints**:
  - `user_id` must reference an existing user
  - `generated_at` must be in the past
  - `valid_until` must be after `generated_at` if specified
  - `cost_usd` must be non-negative

- **Indexes**:
  - `idx_adaptive_path_user_active`: Index on user_id and is_active for quick retrieval of active paths
  - `idx_adaptive_path_generated`: Index on generated_at for time-based queries

- **Relationships**:
  - Belongs to one User
  - References multiple CourseContent items

### 2. LLMGradeAssessment
- **Description**: Stores LLM-graded assessments for free-form responses
- **Attributes**:
  - `id` (UUID, Primary Key): Unique identifier for the LLM grade assessment
  - `user_id` (UUID, Foreign Key): Reference to the user whose response was graded
  - `quiz_attempt_id` (UUID, Foreign Key): Reference to the original quiz attempt
  - `question_id` (UUID, Foreign Key): Reference to the specific question that was LLM-graded
  - `original_response` (Text, Required): The user's original free-form response
  - `llm_grade` (JSON, Required): Detailed grading from the LLM including score and feedback
  - `graded_at` (DateTime, Required): Timestamp when the LLM grading was completed
  - `cost_usd` (Decimal, Optional): Cost incurred to perform the LLM grading
  - `is_valid` (Boolean, Default: True): Whether this grade is still considered valid

- **Constraints**:
  - `user_id` must reference an existing user
  - `quiz_attempt_id` must reference an existing quiz attempt
  - `question_id` must reference an existing question
  - `graded_at` must be in the past
  - `cost_usd` must be non-negative

- **Indexes**:
  - `idx_llm_grade_user_attempt`: Index on user_id and quiz_attempt_id for quick lookup
  - `idx_llm_grade_question`: Index on question_id for analytics

- **Relationships**:
  - Belongs to one User
  - Belongs to one QuizAttempt
  - References one QuizQuestion

### 3. HybridFeatureUsage
- **Description**: Tracks usage of hybrid intelligence features for cost accounting and access control
- **Attributes**:
  - `id` (UUID, Primary Key): Unique identifier for the usage record
  - `user_id` (UUID, Foreign Key): Reference to the user who used the feature
  - `feature_type` (String, 50, Required): Type of hybrid feature used (adaptive_path, llm_grading)
  - `usage_timestamp` (DateTime, Required): When the feature was used
  - `request_details` (JSON, Optional): Details about the request made
  - `response_summary` (JSON, Optional): Summary of the response received
  - `cost_usd` (Decimal, Required): Cost incurred for this usage
  - `tokens_used` (Integer, Optional): Number of tokens consumed (input + output)

- **Constraints**:
  - `user_id` must reference an existing user
  - `feature_type` must be one of the allowed values
  - `usage_timestamp` must be in the past
  - `cost_usd` must be non-negative
  - `tokens_used` must be non-negative if specified

- **Indexes**:
  - `idx_hybrid_usage_user_time`: Index on user_id and usage_timestamp for user activity tracking
  - `idx_hybrid_usage_feature`: Index on feature_type for feature usage analytics
  - `idx_hybrid_usage_date`: Index on usage_timestamp for time-based queries

- **Relationships**:
  - Belongs to one User

### 4. CostMetric
- **Description**: Aggregated cost metrics for billing and analytics
- **Attributes**:
  - `id` (UUID, Primary Key): Unique identifier for the cost metric
  - `user_id` (UUID, Foreign Key): Reference to the user this metric applies to
  - `metric_period_start` (Date, Required): Start date of the metric period
  - `metric_period_end` (Date, Required): End date of the metric period
  - `total_cost_usd` (Decimal, Required): Total cost incurred during the period
  - `total_tokens` (Integer, Required): Total tokens consumed during the period
  - `feature_breakdown` (JSON, Required): Cost breakdown by feature type
  - `calculated_at` (DateTime, Required): When the metrics were calculated

- **Constraints**:
  - `user_id` must reference an existing user
  - `metric_period_end` must be after `metric_period_start`
  - `total_cost_usd` must be non-negative
  - `total_tokens` must be non-negative
  - `calculated_at` must be in the past

- **Indexes**:
  - `idx_cost_metric_user_period`: Index on user_id and metric_period_start for user billing
  - `idx_cost_metric_period`: Index on metric_period_start for period-based queries

- **Relationships**:
  - Belongs to one User

## Migration Strategy

### Phase 1: Schema Creation
1. Create new tables for AdaptiveLearningPath, LLMGradeAssessment, HybridFeatureUsage, and CostMetric
2. Add necessary indexes for performance
3. Establish foreign key relationships

### Phase 2: Data Population
1. Populate CostMetric with historical data if available
2. Ensure existing users can access their data through the new schema

### Phase 3: Integration
1. Connect new models to services and API endpoints
2. Implement triggers or scheduled jobs for cost aggregation

## Performance Considerations

- Use UUIDs for primary keys to ensure global uniqueness across distributed systems
- Implement proper indexing on frequently queried fields
- Consider partitioning large tables (like HybridFeatureUsage) by date
- Cache frequently accessed adaptive learning paths
- Archive older cost metrics to separate tables for performance

## Security Considerations

- Ensure all user data is properly linked to prevent cross-user data access
- Implement proper access controls at the database level
- Encrypt sensitive data if required by privacy regulations
- Log all access to premium feature data for audit purposes