# OAuth 2.0 Configuration (set in GPT Builder → Configure → Actions → Authentication):
#   Auth Type:            OAuth
#   Client ID:            course-companion-fte-gpt
#   Client Secret:        <value of OAUTH_CLIENT_SECRET in Render env>
#   Authorization URL:    https://course-companion-fte.onrender.com/api/v1/oauth/authorize
#   Token URL:            https://course-companion-fte.onrender.com/api/v1/oauth/token
#   Scope:                read write
#   Token Exchange Method: POST request body

openapi: 3.1.0
info:
  title: Course Companion FTE API
  description: Backend API for the Course Companion FTE educational platform. Provides content delivery, quiz management, progress tracking, subscription management, and hybrid intelligence features.
  version: 2.0.0
servers:
  - url: https://course-companion-fte.onrender.com/api/v1
    description: Production server

paths:
  /auth/register:
    post:
      operationId: registerUser
      summary: Register a new user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, full_name, password]
              properties:
                email:
                  type: string
                  format: email
                full_name:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          description: Email already registered

  /auth/login:
    post:
      operationId: loginUser
      summary: Authenticate and get access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                full_name:
                  type: string
                  description: Required by schema but not used for login
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Token"
        "401":
          description: Invalid credentials

  /auth/me:
    get:
      operationId: getCurrentUser
      summary: Get the current authenticated user's profile
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"

  /content/{content_id}:
    get:
      operationId: getContent
      summary: Get specific course content by ID
      security:
        - BearerAuth: []
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Content retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CourseContent"
        "404":
          description: Content not found

  /content/by-course/{course_id}:
    get:
      operationId: getCourseContent
      summary: List all content for a course
      security:
        - BearerAuth: []
      parameters:
        - name: course_id
          in: path
          required: true
          schema:
            type: string
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            maximum: 100
      responses:
        "200":
          description: Course content list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CourseContent"

  /content/search:
    get:
      operationId: searchContent
      summary: Search content by keywords
      security:
        - BearerAuth: []
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
        - name: course_id
          in: query
          schema:
            type: string
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 50
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CourseContent"

  /content/{content_id}/next:
    get:
      operationId: getNextContent
      summary: Get next content in sequence
      security:
        - BearerAuth: []
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Next content item
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CourseContent"
        "404":
          description: No next content available

  /content/{content_id}/prev:
    get:
      operationId: getPreviousContent
      summary: Get previous content in sequence
      security:
        - BearerAuth: []
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Previous content item
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CourseContent"
        "404":
          description: No previous content available

  /content/grounded-qna:
    post:
      operationId: groundedQA
      summary: Find content sections relevant to a student's question
      security:
        - BearerAuth: []
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
            minLength: 1
        - name: course_id
          in: query
          schema:
            type: string
        - name: max_results
          in: query
          schema:
            type: integer
            default: 5
            minimum: 1
            maximum: 10
      responses:
        "200":
          description: Relevant content sections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CourseContent"

  /quiz/{content_id}/start:
    post:
      operationId: startQuiz
      summary: Start a new quiz attempt for a content item
      security:
        - BearerAuth: []
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Quiz attempt started with questions
          content:
            application/json:
              schema:
                type: object
                properties:
                  attempt_id:
                    type: integer
                  questions:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        content_id:
                          type: integer
                        question_text:
                          type: string
                        question_type:
                          type: string
                        options:
                          type: string
                        difficulty_level:
                          type: string

  /quiz/{content_id}/submit:
    post:
      operationId: submitQuiz
      summary: Submit quiz answers for grading
      security:
        - BearerAuth: []
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [answers]
              properties:
                answers:
                  type: array
                  items:
                    type: object
                    required: [question_id, selected_answer]
                    properties:
                      question_id:
                        type: integer
                      selected_answer:
                        type: string
      responses:
        "200":
          description: Quiz grading result
          content:
            application/json:
              schema:
                type: object
                properties:
                  score:
                    type: integer
                  total:
                    type: integer
                  percentage:
                    type: number
                  results:
                    type: array
                    items:
                      type: object
        "404":
          description: Content not found

  /quiz/attempts/{attempt_id}:
    get:
      operationId: getQuizAttempt
      summary: Get details of a specific quiz attempt
      security:
        - BearerAuth: []
      parameters:
        - name: attempt_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Quiz attempt details
          content:
            application/json:
              schema:
                type: object
                properties:
                  attempt:
                    $ref: "#/components/schemas/QuizAttempt"
        "404":
          description: Attempt not found
        "403":
          description: Not authorized to view this attempt

  /progress/{content_id}:
    get:
      operationId: getProgress
      summary: Get progress for a specific content item
      security:
        - BearerAuth: []
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Progress record
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProgressRecord"
        "404":
          description: No progress record found
    put:
      operationId: updateProgress
      summary: Update progress for a content item
      security:
        - BearerAuth: []
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: integer
        - name: status
          in: query
          required: true
          schema:
            type: string
            enum: [not_started, in_progress, completed]
        - name: completion_percentage
          in: query
          schema:
            type: number
            default: 0
            minimum: 0
            maximum: 100
        - name: time_spent_seconds
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        "200":
          description: Progress updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProgressRecord"

  /progress/user/{user_id}:
    get:
      operationId: getUserProgress
      summary: Get all progress records for a user
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
        - name: course_id
          in: query
          schema:
            type: string
      responses:
        "200":
          description: User progress records
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ProgressRecord"
        "403":
          description: Not authorized to view this user's progress

  /subscriptions/current:
    get:
      operationId: getCurrentSubscription
      summary: Get current user's subscription details
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Subscription details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Subscription"
        "404":
          description: No subscription found

  # --- Hybrid Intelligence (Premium) ---

  /hybrid/adaptive-path:
    get:
      operationId: getAdaptivePath
      summary: Get the current adaptive learning path (premium)
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Active adaptive learning path
          content:
            application/json:
              schema:
                type: object
        "404":
          description: No active path found
        "403":
          description: Premium subscription required
    post:
      operationId: generateAdaptivePath
      summary: Generate a new adaptive learning path (premium, LLM-powered)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [learning_style, pace]
              properties:
                learning_style:
                  type: string
                  description: "e.g. visual, reading, hands-on"
                pace:
                  type: string
                  description: "e.g. slow, moderate, fast"
      responses:
        "200":
          description: Generated adaptive learning path
          content:
            application/json:
              schema:
                type: object
        "403":
          description: Premium subscription required

  /hybrid/llm-grade-assessment:
    post:
      operationId: gradeWithLLM
      summary: Submit a free-form answer for LLM grading (premium)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [quiz_attempt_id, question_id, answer_text]
              properties:
                quiz_attempt_id:
                  type: integer
                question_id:
                  type: string
                answer_text:
                  type: string
                context:
                  type: object
      responses:
        "200":
          description: LLM grading result
          content:
            application/json:
              schema:
                type: object
        "403":
          description: Premium subscription required

  /hybrid/agent-orchestrate:
    post:
      operationId: agentOrchestrate
      summary: Route a task to the appropriate AI agent (premium, Agents SDK)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [task]
              properties:
                task:
                  type: string
                  description: Natural language description of the task
      responses:
        "200":
          description: Agent response
          content:
            application/json:
              schema:
                type: object
                properties:
                  agent:
                    type: string
                  response:
                    type: string
        "403":
          description: Premium subscription required

  /hybrid/cost-metrics:
    get:
      operationId: getCostMetrics
      summary: Get LLM usage cost metrics
      security:
        - BearerAuth: []
      parameters:
        - name: period_start
          in: query
          schema:
            type: string
            format: date-time
        - name: period_end
          in: query
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: Cost metrics list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    UserResponse:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
        full_name:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Token:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string

    CourseContent:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        content_type:
          type: string
          enum: [text, video, quiz, exercise]
        content_data:
          type: string
        course_id:
          type: string
        chapter_number:
          type: integer
        section_number:
          type: integer
        is_available:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    QuizAttempt:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        content_id:
          type: integer
        score:
          type: number
        total_questions:
          type: integer
        correct_answers:
          type: integer
        attempt_date:
          type: string
          format: date-time
        time_taken_seconds:
          type: integer
        answers:
          type: string
        created_at:
          type: string
          format: date-time

    ProgressRecord:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        content_id:
          type: integer
        status:
          type: string
          enum: [not_started, in_progress, completed]
        completion_percentage:
          type: number
        time_spent_seconds:
          type: integer
        last_accessed_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Subscription:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        subscription_type:
          type: string
          enum: [free, premium]
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        is_active:
          type: boolean
        payment_status:
          type: string
          enum: [pending, paid, failed]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
